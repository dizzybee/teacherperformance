/**
 *  Copyright (c) 2010 Alethia Inc,
 *  http://www.alethia-inc.com
 *  Developed by Travis Tidwell | travist at alethia-inc.com 
 *
 *  License:  GPL version 3.
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is
 *  furnished to do so, subject to the following conditions:
 *  
 *  The above copyright notice and this permission notice shall be included in
 *  all copies or substantial portions of the Software.

 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 */
(function(a){jQuery.media=jQuery.media?jQuery.media:{};jQuery.media.defaults=jQuery.extend(jQuery.media.defaults,{protocol:"auto",server:"drupal",template:"default",baseURL:"",debug:false,draggable:false,resizable:false,showPlaylist:true,autoNext:true,prefix:"",zIndex:400,fluidWidth:false,fluidHeight:false,fullscreen:false});jQuery.media.ids=jQuery.extend(jQuery.media.ids,{loading:"#mediaplayerloading",player:"#mediaplayer",menu:"#mediamenu",titleBar:"#mediatitlebar",node:"#medianode",playlist:"#mediaplaylist",control:"#mediacontrol"});jQuery.media.players={};jQuery.media.loadCallbacks={};jQuery.media.playlists={};jQuery.media.controllers={};jQuery.media.onLoaded=function(b,d){var c=jQuery.media.players[b];if(c&&c.display&&c.loaded){d(c);}else{if(!jQuery.media.loadCallbacks[b]){jQuery.media.loadCallbacks[b]=[];}jQuery.media.loadCallbacks[b].push(d);}};jQuery.media.addElement=function(d,f,c){if(f&&f[c]){var e=jQuery.media.players[d];if(e){switch(c){case"playlist":e.addPlaylist(f.playlist);break;case"controller":e.addController(f.controller);break;default:break;}}else{var b=c+"s";if(!jQuery.media[b][d]){jQuery.media[b][d]=[];}jQuery.media[b][d].push(f[c]);}}};jQuery.media.addController=function(b,c){jQuery.media.addElement(b,c,"controller");};jQuery.media.addPlaylist=function(b,c){jQuery.media.addElement(b,c,"playlist");};jQuery.fn.mediaplayer=function(b){if(this.length===0){return null;}return new (function(e,f){f=jQuery.media.utils.getSettings(f);if(!f.id){f.id=jQuery.media.utils.getId(e);}this.dialog=e;this.display=this.dialog.find(f.ids.player);var g=this;var c=[];jQuery.media.utils.checkVisibility(this.display,c);jQuery.media.players[f.id]=this;this.loaded=false;var d=0;f.template=jQuery.media.templates[f.template](this,f);if(f.template.getSettings){f=jQuery.extend(f,f.template.getSettings());}a(window).keyup(function(h){switch(h.keyCode){case 0:g.onSpaceBar();break;case 113:case 27:g.onEscKey();break;default:break;}});if(f.fluidWidth||f.fluidHeight){a(window).resize(function(){g.onResize();});}if(jQuery.media[f.protocol]){this.protocol=jQuery.media[f.protocol](f);}if(jQuery.media[f.server]){this.server=jQuery.media[f.server](this.protocol,f);}this.menu=this.dialog.find(f.ids.menu).mediamenu(this.server,f);if(this.menu){this.menu.display.unbind("menuclose").bind("menuclose",function(){g.showMenu(false);});}this.menuOn=false;this.maxOn=!f.showPlaylist;this.fullScreen=false;this.playlist=null;this.activePlaylist=null;this.controller=null;this.activeController=null;this.showMenu=function(h){if(f.template.onMenu){this.menuOn=h;f.template.onMenu(this.menuOn);}};this.onEscKey=function(){if(this.fullScreen){this.onFullScreen(false);}};this.onSpaceBar=function(){if(this.fullScreen&&this.node&&this.node.player){this.node.player.togglePlayPause();}};this.addPlayerEvents=function(h){h.display.unbind("menu").bind("menu",function(i){g.showMenu(!g.menuOn);});h.display.unbind("maximize").bind("maximize",function(i){g.maximize(!g.maxOn);});h.display.unbind("fullscreen").bind("fullscreen",function(i){g.onFullScreen(!g.fullScreen);});};this.onFullScreen=function(h){this.fullScreen=h;if(this.node&&this.node.player){this.node.player.fullScreen(this.fullScreen);this.onResize();if(window.webkitSupportsFullscreen&&window.webkitSupportsFullscreen()){if(h){window.webkitEnterFullscreen();}else{window.webkitExitFullscreen();}}}};this.titleBar=this.dialog.find(f.ids.titleBar).mediatitlebar(f);if(this.titleBar){this.addPlayerEvents(this.titleBar);if(f.draggable&&this.dialog.draggable){this.dialog.draggable({handle:f.ids.titleBar,containment:"document"});}if(f.resizable&&this.dialog.resizable){this.dialog.resizable({alsoResize:this.display,containment:"document",resize:function(h){g.onResize();}});}}this.node=this.dialog.find(f.ids.node).medianode(this.server,f);if(this.node){this.node.display.unbind("nodeload").bind("nodeload",function(h,i){g.onNodeLoad(i);});if(this.node.player&&this.node.player.media){this.node.player.media.display.unbind("mediaupdate").bind("mediaupdate",function(h,i){g.onMediaUpdate(i);});}if(this.node.uservoter){this.node.uservoter.display.unbind("voteSet").bind("voteSet",function(i,h){if(g.activePlaylist){g.activePlaylist.onVoteSet(h);}});}}this.onMediaUpdate=function(h){this.node.player.onMediaUpdate(h);if(f.autoNext&&this.activePlaylist&&(h.type=="complete")){this.activePlaylist.loadNext();}if(this.controller){this.controller.onMediaUpdate(h);}if(this.activeController){this.activeController.onMediaUpdate(h);}if(this.menu&&this.node&&(h.type=="meta")){this.menu.setEmbedCode(this.node.player.media.player.getEmbedCode());this.menu.setMediaLink(this.node.player.media.player.getMediaLink());}if(f.template&&f.template.onMediaUpdate){f.template.onMediaUpdate(h);}};this.onPlaylistLoad=function(h){if(this.node){if(this.node.player&&this.node.player.media){this.node.player.media.hasPlaylist=true;}this.node.loadNode(h);}if(f.template.onPlaylistLoad){f.template.onPlaylistLoad(h);}};this.onNodeLoad=function(h){if(f.template.onNodeLoad){f.template.onNodeLoad(h);}};this.maximize=function(h){if(!this.fullScreen){if(f.template.onMaximize&&(h!=this.maxOn)){this.maxOn=h;f.template.onMaximize(this.maxOn);}}};this.addPlaylist=function(h){if(h){h.display.unbind("playlistload").bind("playlistload",h,function(i,j){g.activePlaylist=i.data;g.onPlaylistLoad(j);});if(!this.activePlaylist&&h.activeTeaser){this.activePlaylist=h;this.onPlaylistLoad(h.activeTeaser.node.nodeInfo);}}return h;};this.searchForElement=function(h){for(var j in h){var i=new RegExp("^"+j+"(\\_[0-9]+)?$","i");if(f.id.search(i)===0){return h[j];}}return null;};this.playlist=this.addPlaylist(this.dialog.find(f.ids.playlist).mediaplaylist(this.server,f));this.addController=function(i,h){if(i){i.display.unbind("controlupdate").bind("controlupdate",i,function(j,k){g.activeController=j.data;if(g.node&&g.node.player){g.node.player.onControlUpdate(k);}});if(h&&!this.activeController){this.activeController=i;}this.addPlayerEvents(i);}return i;};this.controller=this.addController(this.dialog.find(f.ids.control).mediacontrol(f),false);if(this.controller&&this.node){this.node.addVoters(this.controller.display);}this.onResize=function(){if(f.template.onResize){f.template.onResize();}if(this.node){this.node.onResize();}if(this.controller){this.controller.onResize();}};this.showNativeControls=function(h){var i=this.node?this.node.player:null;if(i&&i.hasControls()){i.usePlayerControls=h;if(h){i.busy.hide();i.play.hide();if(i.preview){i.preview.display.hide();}if(this.controller){this.controller.display.hide();}}else{i.showBusy(1,((this.busyFlags&2)==2));i.showPlay(this.playVisible);i.showPreview(this.previewVisible);if(this.controller){this.controller.display.show();}}i.showControls(h);}};this.loadContent=function(){var j=this.searchForElement(jQuery.media.controllers);if(j){d=j.length;while(d){d--;this.addController(j[d],true);}}var h=this.searchForElement(jQuery.media.playlists);if(h){d=h.length;while(d){d--;this.addPlaylist(h[d]);}}var i=false;if(this.playlist){i=this.playlist.loadPlaylist();}if(!i&&this.node){if(this.node.player&&this.node.player.media){this.node.player.media.settings.repeat=(f.loop||f.repeat);}this.node.loadNode();}};this.initializeTemplate=function(){if(f.template.initialize){f.template.initialize(f);}jQuery.media.utils.resetVisibility(c);};this.load=function(){this.initializeTemplate();this.dialog.css("position","relative");this.dialog.css("marginLeft",0);this.dialog.css("overflow","visible");if(f.fullscreen){this.onFullScreen(true);}this.loaded=true;this.display.trigger("playerLoaded",this);if(jQuery.media.loadCallbacks[f.id]){var j=jQuery.media.loadCallbacks[f.id];var h=j.length;while(h){h--;j[h](this);}}this.server.connect(function(i){g.loadContent();});};this.load();})(this,b);};})(jQuery);